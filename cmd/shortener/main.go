// Shortener - service for short URL generation.
package main

import (
	"context"
	"database/sql"
	_ "net/http/pprof"
	"sync"
	"time"

	_ "github.com/shulganew/shear.git/docs" // docs is generated by Swag CLI, you have to import it.
	"github.com/shulganew/shear.git/internal/app"
	"github.com/shulganew/shear.git/internal/config"
	"github.com/shulganew/shear.git/internal/service"
	"github.com/shulganew/shear.git/internal/web/server"
	"go.uber.org/zap"
)

const timeoutShutdown = time.Second * 20

var (
	buildVersion string = "N/A"
	buildDate    string = "N/A"
	buildCommit  string = "N/A"
)

// @Title Shortener API
// @Description Shortener service.
// @Version 1.0

// @Contact.email shulganew@gmail.com

// @BasePath /
// @Host localhost:8080
func main() {
	app.Intro(buildVersion, buildDate, buildCommit)
	app.InitLog()

	// Root app context.
	ctx, cancel := app.InitContext()

	// Timer hardreset shutdown.
	context.AfterFunc(ctx, func() {
		ctx, cancelCtx := context.WithTimeout(context.Background(), timeoutShutdown)
		defer cancelCtx()
		<-ctx.Done()
		zap.S().Fatalln("failed to gracefully shutdown the service")
	})

	// Wg for main components.
	wgroot := &sync.WaitGroup{}
	// Wg for asinc deleleting shorts.
	wgdel := &sync.WaitGroup{}

	// Exit after all components will be done. Database should be closed after all components complited.
	defer func() {
		wgroot.Wait()
		zap.S().Infoln("App done.")
	}()

	conf := config.NewConfig()

	var db *sql.DB
	var err error
	// If use persistent sorage - init it.
	if conf.IsDB() {
		db, err = app.InitDB(ctx, conf.GetDSN())
		if err != nil {
			db = nil
			conf.SetIsDB(false)
			zap.S().Errorln("Can't connect to Database!", err)
		}
		// Exit after all components will be done. Database should be closed after all components complited.
		defer func() {
			wgroot.Wait()
			err := db.Close()
			if err != nil {
				zap.S().Errorln("Error closing DB: ", err)
			} else {
				zap.S().Infoln("DB closed.")
			}
		}()
	}

	// Error channel.
	componentsErrs := make(chan error, 1)

	// Use fanIn pattern for storing data from delete requests.
	finalCh := make(chan service.DelBatch, 100)
	defer close(finalCh)

	// Init application.
	short, backup, del := app.InitApp(ctx, *conf, db, finalCh, wgdel)

	// Start web server.
	server.ShortenerServer(ctx, wgroot, wgdel, db, conf, short, del, componentsErrs)

	// Update deleted shorts from commont fan-In channel.
	app.DeleteShort(ctx, wgroot, short, finalCh)

	// Graceful shutdown.
	app.Shutdown(ctx, wgroot, wgdel, conf, short, backup)

	select {
	// Exit on root context done.
	case <-ctx.Done():
	// Exit on errors.
	case err := <-componentsErrs:
		zap.S().Errorln("Get server error: ", err)
		cancel()
	}
}
